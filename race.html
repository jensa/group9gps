<!DOCTYPE html>
<html>
<head>
	<title>Hackathon</title>
	<script type="text/javascript" src="http://studs.gpsgate.com/Services/Core.ashx?xss2=true&deps=true"></script>
	<!--<script type="text/javascript" src="http://192.168.0.37/GpsGateServer/Services/Core.ashx?xss2=true&deps=true"></script>-->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<script>
		goog.require('GpsGate.Session');
		goog.require('GpsGate.Server');
		goog.require('MochiKit.Async');
		goog.require('jQuery');
	</script>
	<script>
		GpsGate.require('GpsGate.Server.Hackathon');
	</script>
	<script type="text/javascript">
		jQuery.fn.rotate = function(degrees) {
			jQuery(this).css({ '-webkit-transform': 'rotate(' + degrees + 'deg)',
				'-moz-transform': 'rotate(' + degrees + 'deg)',
				'-ms-transform': 'rotate(' + degrees + 'deg)',
				'transform': 'rotate(' + degrees + 'deg)'
			});
		};

		app = function() {
			this.appId = 5;
			this.username = 'team9';
			this.password = '1234';
			//this.appId = 111;
			//this.username = 'team1';
			//this.password = '1234';
			this.position = null;
			this.pollHandler = null;
			this.running = false;
			this.code = null;
			this.watermark = null;
			this.orientation = null;
			this.locations = []; // [{name:'poi1', distance: 912, heading: 0}, {name:'poi2', distance: 100, heading: 45}, {name:'poi3', distance: 512, heading: 180}];
			this.sent = 0;
			this.map = null;
			this.marker = null;
		};

		app.prototype.login = function() {
			return GpsGate.Session.login(this.username, this.password, { appId: this.appId }).addCallbacks(
					function(result) {
						// OK
					},
					this.onError
				);
		};

		app.prototype.getNearbyLocations = function() {
			return GpsGate.Server.Hackathon.GetNearbyLocations().addCallbacks(
					function(result) {
						for (var index in result) {
							console.log(result[index].name + ' ' + result[index].distance);
						}
					},
					this.onError
				);
		};

		app.prototype.updatePosition = function() {
			if (this.position) {
				return GpsGate.Server.Hackathon.UpdatePosition(this.position.lat, this.position.lng, this.position.heading, this.position.speed, this.code)
					.addCallbacks(function() {
						// OK
					},
					this.onError
				);
			}
		};

		app.prototype.getUsers = function() {
			var self = this;
			return GpsGate.Server.Hackathon.GetUpdatedUsers().addCallbacks(
					function(result) {
						self.watermark = result.queryTimeStamp;
					},
					this.onError
				);
		};

		app.prototype.getLocalPosition = function() {
			var deferred = new MochiKit.Async.Deferred();

			if (navigator && navigator.geolocation) {
				var options = { enableHighAccuracy: true };
				var self = this;
				jQuery('#gps').html('Get pos...');
				navigator.geolocation.getCurrentPosition(
					function(pos) {
						deferred.callback({ lat: pos.coords.latitude, lng: pos.coords.longitude, heading: pos.heading, speed: pos.speed });
						jQuery('#accuracy').html(pos.coords.accuracy);
						jQuery('#gps').html('GPS ok');
					},
					function(error) {
						jQuery('#gps').html('GPS error');
					},
					options
				);
			}
			else {
				deferred.callback();
			}

			return deferred;
		};

		app.prototype.refreshPosition = function() {
			if (!this.running) return;

			var self = this;
			self.getLocalPosition().addCallback(function(newPosition) {

				if (newPosition) {
					if (!self.position || self.position.lat != newPosition.lat || self.position.lng != newPosition.lng) {
						self.position = newPosition;
						self.updatePosition().addCallback(function() {
							self.sent++;
							jQuery('#sent').html(self.sent);
							self.getNearbyLocations().addCallback(function(locations) {
								self.locations = locations;
							});

							var gLatLng = new google.maps.LatLng(self.position.lat,self.position.lng);;
							if(self.marker) {
								
								self.marker.setPosition(gLatLng);
							}
							else {
								self.marker = new google.maps.Marker({
									  position: gLatLng,
									  map: self.map,
									  title: 'Hello World!'
								  });
							 }
							self.map.panTo(gLatLng);

							self.pollHandler = setTimeout(method(self, self.refreshPosition), 1000);
						});
					}
					else {
						self.pollHandler = setTimeout(method(self, self.refreshPosition), 1000);
					}
				}
				else {
					self.pollHandler = setTimeout(method(self, self.refreshPosition), 1000);
				}
			});
		};

		app.prototype.initEvents = function() {
			this.log('Supports Orientation: ' + (window.DeviceOrientationEvent ? 'Yes' : 'No'));
			if (window.DeviceOrientationEvent) {
				var self = this;
				window.addEventListener('deviceorientation', function(data) {
					self.orientation = data;
				});
			}
		};

		app.prototype.initUI = function() {
			var self = this;
			function renderUI() {
				setTimeout(function() {
					if (self.locations) {
						jQuery('#poi').empty();
						for (var i = 0; i < self.locations.length; i++) {
							var loc = self.locations[i];
							var id = loc.name.replace(' ', '');
							var alpha = self.orientation ? self.orientation.alpha : 0;
							var rel = (loc.heading + alpha) % 360;
//							jQuery('#poi').append('<div class="poi"><span class="title">' + loc.name + '</span><br><span>' + 'Hdg: ' + loc.heading + ', Alpha: ' + Math.round(alpha) + ', Arrow: ' + Math.round(rel) + ', ' + Math.round(loc.distance) + ' m </span><div id="_' + id + '" class="compass"></div></div>');
							jQuery('#poi').append('<div class="poi"><span class="title">' + loc.name + '</span><br><span>' + Math.round(loc.distance) + ' m </span><div id="_' + id + '" class="compass"></div></div>');

							rel = Math.round(rel);
							jQuery('#_' + id).rotate(rel);
						}
					}
					if (self.running) {
						renderUI();
					}
				}, 500);
			}

			renderUI();

			var mapOptions = {
				center: new google.maps.LatLng(-34.397, 150.644),
				zoom: 19
			};
			this.map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		};

		app.prototype.start = function() {
			this.running = true;
			this.initEvents();
			this.initUI();

			this.log('Started');
			this.refreshPosition();
		};

		app.prototype.stop = function() {
			if (this.pollHandler) clearTimeout(this.pollHandler);
			this.running = false;
		};

		app.prototype.onError = function(error) {
			this.log('err: ' + error.message);
		};

		app.prototype.log = function(msg) {
			// jQuery('#log').html(msg + '<br>' + jQuery('#log').html());
		};

		

		function start() {
			var tf = new app();
			tf.login().addCallback(function() {
				tf.start();
			});
		}

		google.maps.event.addDomListener(window, 'load', start);
			
	</script>
	<style>
		html { height: 100% }
		body { height: 100%; margin: 0; padding: 0 }
		#map-canvas { height: 400px; }
      
		.poi {
			width: 100%;
			height: 200px;
			padding: 10px;
			background: #f5f7f9;
			border: 1px solid #dfdfdf;
			border-radius: 10px;
			margin: 3px 2px 6px 2px;
			font-size: xx-large;
		}
		
		.title {
			font-weight: bold;
		}
		
		.compass {
			height: 100px;
			width: 100px;
			background-image: url("http://4vector.com/i/free-vector-tango-blue-go-up_100349_tango_blue_go_up.png");
			background-size: 100px 100px;
			float: right;
			margin-right: 80px;
		}
	</style>
</head>
<body>
	<div>
		
		<div id="info">
			<span id="gps"></span>
			<br />
			<span id="accuracy"></span>
			<br />
			<span id="sent"></span>
		</div>
		<div id="map-canvas"></div>
		<div id="poi"></div>
		<div id="log">
		</div>
	</div>
</body>
</html>
